"use strict";(self.webpackChunk_jupyterlite_terminal=self.webpackChunk_jupyterlite_terminal||[]).push([[385],{312:(e,t,s)=>{s.d(t,{X:()=>n});class n{isTerminal(){return!1}async readAsync(e){return[]}read(e){return[]}}},385:(e,t,s)=>{s.d(t,{g:()=>be});var n={};s.r(n),s.d(n,{AliasCommand:()=>O,BuiltinCommand:()=>y,CdCommand:()=>T,ClearCommand:()=>M,CockleConfigCommand:()=>j,ExitCommand:()=>G,ExportCommand:()=>q,FalseCommand:()=>R,HelpCommand:()=>z,HistoryCommand:()=>K,TrueCommand:()=>N,WhichCommand:()=>ee});var i=s(8301),r=s(7262),a=s(9399),o=s(4133),l=s(3291);class c{outputCallback;termios;constructor(e,t){this.outputCallback=e,this.termios=t}async canEnable(){await(this._available?.promise)}async disable(){this._enabled&&(this._enabled=!1,this._clear(),this._available?.resolve())}async enable(){this._enabled=!0,this._available=new r.PromiseDelegate}get enabled(){return this._enabled}utf8ArrayToString(e){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(e)}write(e){let t=[];t="string"==typeof e?this._processWriteChars(e.split("").map(e=>e.charCodeAt(0))):this._processWriteChars(e),this.outputCallback(String.fromCharCode(...t))}_maybeEchoToOutput(e){const t=this.termios.get(),s=(t.c_lflag&o.G.LocalFlag.ECHO)>0,n=(t.c_lflag&o.G.LocalFlag.ECHONL)>0;if(!s&&!n)return;const i=[];for(const t of e)switch(t){case 10:i.push(10);break;case 4:break;default:s&&i.push(t)}i.length>0&&this.write(i)}_processReadChars(e){const t=this.termios.get(),s=[];for(const n of e)switch(n){case 13:0===(t.c_iflag&o.G.InputFlag.IGNCR)&&((t.c_iflag&o.G.InputFlag.ICRNL)>0?s.push(10):s.push(13));break;case 10:(t.c_iflag&o.G.InputFlag.INLCR)>0?s.push(13):s.push(10);break;default:s.push(n)}return s}_processWriteChars(e){const t=this.termios.get(),{c_oflag:s}=t,n=[];for(let t=0;t<e.length;t++){const i=e[t];if(27===i){const s=e.at(t+1);if(91===s||93===s){const s=91===e[t+1],i=e.slice(t+2).findIndex(e=>s?(0,l.D$)(e):7===e||27===e);if(i>0){const s=e.slice(t,t+i+3);n.push(...s),t+=i+2;const r=String.fromCharCode(...s);this._inAlternativeBuffer||r!==a.Q.enableAlternativeBuffer?this._inAlternativeBuffer&&r===a.Q.disableAlternativeBuffer&&(this._inAlternativeBuffer=!1):this._inAlternativeBuffer=!0;continue}}else if(void 0!==s){const s=e.slice(t,t+2);n.push(...s),t+=1;continue}}switch(i){case 10:if(0===this._writeColumn&&(s&o.G.OutputFlag.ONOCR)>0)break;this._writeColumn=0,(s&o.G.OutputFlag.ONLCR)>0?n.push(13,10):n.push(10);break;default:!this._inAlternativeBuffer&&i>=32&&this._writeColumn++,n.push(i)}}return n}_readFromBuffer(e){if(null===e){const e=this._readBuffer;return this._readBuffer=[],e}{const t=this._readBuffer.slice(0,e);return this._readBuffer.splice(0,t.length),t}}_available;_enabled=!1;_inAlternativeBuffer=!1;_utf8Decoder;_writeColumn=0;_readBuffer=[]}class h extends c{constructor(e,t,s,n,r){super(e,t),this._utils=new i.F(s,n,r)}poll(e){if(!this._enabled)throw new Error("ServiceWorkerWorkerIO.poll when disabled");let t=this._readBuffer.length>0;if(!t&&e>0){const s=this._utils.getStdin(e);this._postRead(s),t=!0}return 4|(t?1:0)}read(e){if(!this._enabled)throw new Error("ServiceWorkerWorkerIO.read when disabled");if(null!==e&&e<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(e);const t=this._utils.getStdin(0);return this._postRead(t),this._readFromBuffer(e)}async readAsync(e,t){if(!this._enabled)throw new Error("ServiceWorkerWorkerIO.readAsync when disabled");if(null!==e&&e<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(e);const s=await this._utils.getStdinAsync(t);return this._postRead(s),this._readFromBuffer(e)}_clear(){}_postRead(e){const t=e.split("").map(e=>e.charCodeAt(0)),s=this._processReadChars(t);this._readBuffer.push(...s),this._maybeEchoToOutput(s)}_utils}var u=s(763);class d extends c{constructor(e,t,s){super(e,t);const n=u.X.maxChars+3;this._sharedArrayBuffer=s,this._intArray=new Int32Array(this._sharedArrayBuffer,0,n)}poll(e){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.poll when disabled");return this._readBuffer.length>0?5:(e<0&&(e=1/0),4|("not-equal"===Atomics.wait(this._intArray,u.X.MAIN,this._readCount,e)?1:0))}read(e){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.read when disabled");return null!==e&&e<=0?[]:this._readBuffer.length>0?this._readFromBuffer(e):(Atomics.wait(this._intArray,u.X.MAIN,this._readCount),this._postRead(e))}async readAsync(e,t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.readAsync when disabled");if(null!==e&&e<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(e);const{async:s,value:n}=Atomics.waitAsync(this._intArray,u.X.MAIN,this._readCount,t>0?t:1/0);return s&&await n,this._postRead(e)}_postRead(e){if(Atomics.load(this._intArray,u.X.MAIN)===this._readCount)return[];const t=this._loadFromSharedArrayBuffer();return this._readCount++,Atomics.store(this._intArray,u.X.WORKER,this._readCount),Atomics.notify(this._intArray,u.X.WORKER,1),this._readBuffer=this._processReadChars(t),this._maybeEchoToOutput(this._readBuffer),this._readFromBuffer(e)}_clear(){this._intArray[u.X.MAIN]=0,this._intArray[u.X.WORKER]=0,this._readCount=0}_loadFromSharedArrayBuffer(){const e=Atomics.load(this._intArray,u.X.LENGTH),t=[];for(let s=0;s<e;s++)t.push(Atomics.load(this._intArray,u.X.START+s));return t}_sharedArrayBuffer;_intArray;_readCount=0}class m{setMainIO;setWorkerIO;constructor(e,t){this.setMainIO=e,this.setWorkerIO=t,this._map.set("sab",{longName:"shared array buffer",available:!1}),this._map.set("sw",{longName:"service worker",available:!1})}available(e){return this._getByShortName(e).available}get enabled(){return this._enabled}get shortNames(){return Array(...this._map.keys())}longName(e){return this._getByShortName(e).longName}setAvailable(e,t){this._getByShortName(e).available=t}setEnabled(e){if(this._map.has(e))return void this._enable(e);const t=Object.entries(this._map).find(([t,s])=>s.longName===e);if(void 0===t)throw new Error(`Unknown StdinContext name '${e}'`);this._enable(t[0])}_enable(e){if(e!==this._enabled){if(!this._getByShortName(e).available)throw new Error(`StdinContext '${e}' is not available`);this._enabled=e,this._initialised?(this.setWorkerIO(e),this.setMainIO(e)):this._initialised=!0}}_getByShortName(e){const t=this._map.get(e);if(void 0===t)throw new Error(`Unknown shortName '${e}' passed to StdinContext`);return t}_map=new Map;_enabled="";_initialised=!1}var p,f=s(7450);class _{get(e,t){const s=this.key(e,t);return this._cache.get(s)??void 0}has(e,t){const s=this.key(e,t);return this._cache.has(s)}key(e,t){return[e,t].join("/")}set(e,t,s){const n=this.key(e,t);this._cache.set(n,s)}_cache=new Map}class g{wasmBaseUrl;downloadModuleCallback;constructor(e,t){this.wasmBaseUrl=e,this.downloadModuleCallback=t}getJavaScriptModule(e,t){const s=this._getModule(e,t,!1);return void 0!==s?s:void 0}getWasmModule(e,t){const s=this._getModule(e,t,!0);return void 0!==s?s:void 0}_getModule(e,t,s){let n=this.cache.get(e,t);if(void 0===n){const i=this.cache.key(e,t)+".js",r=(0,l.oq)(this.wasmBaseUrl,i);console.log(`Cockle loading ${s?"WebAssembly":"JavaScript"} module from ${r}`),this.downloadModuleCallback(e,t,!0);try{importScripts(r),n=self.Module}finally{this.downloadModuleCallback(e,t,!1)}void 0!==n&&this.cache.set(e,t,n)}return n}cache=new _}!function(e){e[e.None=0]="None",e[e.Unknown=1]="Unknown",e[e.Builtin=2]="Builtin",e[e.External=4]="External",e[e.JavaScript=8]="JavaScript",e[e.Wasm=16]="Wasm",e[e.All=31]="All"}(p||(p={}));var C=s(7095);class w{name;callExternalCommand;callExternalTabComplete;constructor(e,t,s){this.name=e,this.callExternalCommand=t,this.callExternalTabComplete=s}get commandType(){return p.External}get moduleName(){return"<external>"}names(){return[this.name]}get packageName(){return""}async run(e){const{name:t,args:s,environment:n,stdin:i,stdout:r,stderr:a}=e;if(t!==this.name)throw new C.xZ(t);const{exitCode:o,environmentChanges:l}=await this.callExternalCommand(t,s,Object.fromEntries(n),i.isTerminal(),r.supportsAnsiEscapes(),a.supportsAnsiEscapes(),e.termios.get());return void 0!==l&&Object.entries(l).forEach(([e,t])=>{void 0===t?n.delete(e):n.set(e,t)}),o}async tabComplete(e){if(void 0!==this.callExternalTabComplete){const{name:t,args:s}=e;return await this.callExternalTabComplete(t,s)}return{}}}class y{get commandType(){return p.Builtin}get moduleName(){return"<builtin>"}get packageName(){return""}names(){return[this.name]}run(e){const{name:t}=e;if(t!==this.name)throw new C.xZ(t);return this._run(e)}}var S=s(2199),b=s(5874),x=s(3482);class k extends b.k{description="Without arguments, 'alias' prints the list of aliases in the reusable\n    form 'alias NAME=VALUE' on standard output.\n\n    Otherwise, an alias is defined for each NAME whose VALUE is given.\n    A trailing space in VALUE causes the next word to be checked for\n    alias substitution when the alias is expanded.";positional=new S.Tl;help=new S.C8("h","help","display this help and exit")}class O extends y{get name(){return"alias"}async tabComplete(e){return await(new k).tabComplete(e)}async _run(e){const{aliases:t,stdout:s}=e,n=(new k).parse(e.args);if(n.help.isSet)return n.writeHelp(s),x.y.SUCCESS;if(n.positional.isSet)for(const e of n.positional.strings){const n=e.indexOf("=");-1===n?s.write(`${e}='${t.get(e)}'\n`):t.set(e.slice(0,n),e.slice(n+1))}else for(const[e,n]of t.entries())s.write(`${e}='${n}'\n`);return x.y.SUCCESS}}class v extends b.k{help=new S.C8("h","help","display this help and exit")}class I extends v{description="Always succeeds; Return a successful result."}class E extends v{description="Always fails; Return an unsuccessful result."}class N extends y{get name(){return"true"}async tabComplete(e){return await(new I).tabComplete(e)}async _run(e){const t=(new I).parse(e.args);return t.help.isSet?(t.writeHelp(e.stdout),x.y.SUCCESS):x.y.SUCCESS}}class R extends y{get name(){return"false"}async tabComplete(e){return await(new E).tabComplete(e)}async _run(e){const t=(new E).parse(e.args);return t.help.isSet?(t.writeHelp(e.stdout),x.y.SUCCESS):x.y.GENERAL_ERROR}}var A=s(955);class L extends b.k{description='Change the shell working directory.\n  \n  Change the current directory to DIR. If DIR is "-", it is converted to $OLDPWD.';positional=new S.ET({pathType:A.y.Directory});help=new S.C8("h","help","display this help and exit")}class T extends y{get name(){return"cd"}async tabComplete(e){return await(new L).tabComplete(e)}async _run(e){const t=(new L).parse(e.args);if(t.help.isSet)return t.writeHelp(e.stdout),x.y.SUCCESS;const s=t.positional.strings;if(s.length<1)return x.y.SUCCESS;if(s.length>1)throw new C.$g("cd: too many arguments");let n=s[0];if("-"===n){const t=e.environment.get("OLDPWD");if(void 0===t)throw new C.$g("cd: OLDPWD not set");n=t,e.stdout.write(`${n}\n`)}const{FS:i}=e.fileSystem,r=i.cwd();return i.chdir(n),e.environment.set("OLDPWD",r),e.environment.set("PWD",i.cwd()),x.y.SUCCESS}}class B extends b.k{description="Clear the terminal screen if ANSI escapes are supported.";help=new S.C8("h","help","display this help and exit")}class M extends y{get name(){return"clear"}async tabComplete(e){return await(new B).tabComplete(e)}async _run(e){const{stdout:t}=e,s=(new B).parse(e.args);return s.help.isSet?(s.writeHelp(t),x.y.SUCCESS):(t.supportsAnsiEscapes()&&t.write(a.Q.eraseScreen+a.Q.eraseSavedLines+a.Q.cursorHome),x.y.SUCCESS)}}var W=s(585),F=s(3694);class D extends b.s{help=new S.C8("h","help","display this help and exit");builtin=new S.C8("b","builtin","display only builtin commands");external=new S.C8("e","external","display only external commands");javascript=new S.C8("j","javascript","display only javascript commands");wasm=new S.C8("w","wasm","display only wasm commands");positional=new S.Tl({tabComplete:async e=>({possibles:e.commandRegistry?.match(e.args.at(-1)||"",Q(this))??[]})})}class $ extends b.s{positional=new S.Tl({tabComplete:async e=>({possibles:e.commandRegistry?.allModules().map(e=>e.name)??[]})})}class P extends b.s{positional=new S.Tl({tabComplete:async e=>({possibles:e.commandRegistry?[...e.commandRegistry.commandPackageMap.keys()]:[]})})}class U extends b.s{positional=new S.Tl({max:1,tabComplete:async e=>({possibles:e.stdinContext?.shortNames??[]})})}class H extends b.k{description="Inspect and optionally modify Cockle configuration. Without arguments prints all sections. Use subcommands to target specific areas.";version=new S.C8("v","version","show cockle version");help=new S.C8("h","help","display this help and exit");subcommands={command:new D("command","Show information about one or more commands."),module:new $("module","Show information about one or more modules."),package:new P("package","Show information about one or more packages."),stdin:new U("stdin","Configure or show synchronous stdin settings.")}}class j extends y{get name(){return"cockle-config"}async tabComplete(e){return await(new H).tabComplete(e)}async _run(e){const{environment:t,stdout:s}=e,n=(new H).parse(e.args),{subcommands:i}=n;if(n.help.isSet)return n.writeHelp(s),x.y.SUCCESS;const r=s.supportsAnsiEscapes()&&t.color?W.Ju.defaultColorByColumn():void 0,a=0===e.args.length;if((a||n.version.isSet)&&this._writeVersion(e),(a||i.stdin.isSet)&&this._writeOrSetSyncStdinConfig(e,r,i.stdin.positional.strings.at(0)),(a||i.package.isSet)&&this._writePackageConfig(e,r,i.package.positional.strings),(a||i.module.isSet)&&this._writeModuleConfig(e,r,i.module.positional.strings),i.command.isSet){const{command:t}=i;if(t.help.isSet)return t.writeHelp(s),x.y.SUCCESS;this._writeCommandConfig(e,r,t)}return x.y.SUCCESS}_writeCommandConfig(e,t,s){const{commandRegistry:n,stdout:i}=e,r=s.positional.strings;let a=n.commandNames(Q(s));if(r.length>0){const e=r.filter(e=>!a.includes(e));if(e.length>0)throw new C.$g(`Unknown command(s): ${e.sort().join(" ")}`);a=r.sort()}const o=new W.Ju({colorByColumn:t,sortByColumn:[0]});o.addHeaderRow(["command","module"]);for(const e of a){const t=n.get(e);if(null===t)throw new C.$g(`Unknown command '${e}'`);o.addRow([e,t.moduleName])}o.write(i)}_writeModuleConfig(e,t,s){const{commandRegistry:n,commandModuleCache:i,stdout:r}=e;let a=n.allModules();const o=a.map(e=>e.name);if(s.length>0){const e=s.filter(e=>!o.includes(e));if(e.length>0)throw new C.$g(`Unknown module(s): ${e.sort().join(" ")}`);a=a.filter(e=>s.includes(e.name))}const l=new W.Ju({colorByColumn:t,sortByColumn:[0,1]});l.addHeaderRow(["module","package","cached"]);for(const e of a)l.addRow([e.name,e.packageName,i.has(e.packageName,e.name)?"yes":""]);l.write(r)}_writeOrSetSyncStdinConfig(e,t,s){const{stdinContext:n,stdout:i}=e;void 0!==s&&n.setEnabled(s);const r=new W.Ju({colorByColumn:t});r.addHeaderRow(["synchronous stdin","short name","available","enabled"]);const{enabled:a,shortNames:o}=n;for(const e of o)r.addRow([n.longName(e),e,n.available(e)?"yes":"",a===e?"yes":""]);r.write(i)}_writePackageConfig(e,t,s){const{commandRegistry:n,stdout:i}=e;let r=[...n.commandPackageMap.keys()];if(s.length>0){const e=s.filter(e=>!r.includes(e));if(e.length>0)throw new C.$g(`Unknown package(s): ${e.sort().join(" ")}`);r=s.sort()}const a=new W.Ju({colorByColumn:t,sortByColumn:[0]});a.addHeaderRow(["package","type","version","build string","source"]);for(const e of r){const t=n.commandPackageMap.get(e);a.addRow([t.name,t.wasm?"wasm":"js",t.version,t.build_string,t.channel])}a.write(i)}_writeVersion(e){const{stdout:t}=e;t.write(`cockle ${F.Z}\n`)}}function Q(e){let t=p.None;return e.builtin.isSet&&(t|=p.Builtin),e.external.isSet&&(t|=p.External),e.javascript.isSet&&(t|=p.JavaScript),e.wasm.isSet&&(t|=p.Wasm),t===p.None&&(t=p.All),t}class V extends b.k{description="Exit the shell";help=new S.C8("h","help","display this help and exit")}class G extends y{get name(){return"exit"}async tabComplete(e){return await(new V).tabComplete(e)}async _run(e){const{stdout:t,terminate:s}=e,n=(new V).parse(e.args);return n.help.isSet?(n.writeHelp(t),x.y.SUCCESS):(t.write("Terminating shell...\n"),t.flush(),s(),x.y.SUCCESS)}}class X extends b.k{description="Set export attribute for shell variables.\n    \n    Marks each NAME for automatic export to the environment of subsequently\n    executed commands.  If VALUE is supplied, assign VALUE before exporting.";positional=new S.Tl;help=new S.C8("h","help","display this help and exit")}class q extends y{get name(){return"export"}async tabComplete(e){return await(new X).tabComplete(e)}async _run(e){const{environment:t,stdout:s}=e,n=(new X).parse(e.args);if(n.help.isSet)return n.writeHelp(s),x.y.SUCCESS;if(n.positional.isSet)for(const e of n.positional.strings){const s=e.indexOf("=");if(s>0){const n=e.slice(0,s),i=e.slice(s+1);t.set(n,i)}}return x.y.SUCCESS}}class Y extends b.k{description="Show help for built-in commands. With no arguments, lists available builtins. With names, shows each command's help (equivalent to '<cmd> --help').";help=new S.C8("h","help","display this help and exit");positional=new S.Tl({tabComplete:async e=>({possibles:e.commandRegistry?.commandNames(p.Builtin)??[]})})}class z extends y{get name(){return"help"}async tabComplete(e){return await(new Y).tabComplete(e)}async _run(e){const{args:t,stdout:s,stderr:n,commandRegistry:i}=e,r=(new Y).parse(t);if(r.help.isSet)return r.writeHelp(s),x.y.SUCCESS;const a=r.positional.strings,o=i?i.commandNames(p.Builtin):[];if(0===a.length){s.write("Built-in commands:\n");for(const e of o)s.write(`  ${e}\n`);return s.write("\n"),s.write("For detailed help, type <command-name> --help (e.g., `history --help` or `alias -h`)."),x.y.SUCCESS}let l=x.y.SUCCESS;for(const t of a){if(!o.includes(t)){n.write(`help: unknown built-in: ${t}\n`),l=x.y.GENERAL_ERROR;continue}const r=i.get(t);if(null===r){n.write(`help: failed to get command '${t}'\n`),l=x.y.GENERAL_ERROR;continue}const a={...e,name:t,args:["--help"]};s.write(`\n=== help for ${t} ===\n`),await r.run(a)}return l}}class J extends b.k{description=" Display or manipulate the history list.\n\n    Display the history list with line numbers, prefixing each modified\n    entry with a '*'";clear=new S.C8("c","","clear the history by deleting all of the entries");help=new S.C8("h","help","display this help and exit")}class K extends y{get name(){return"history"}async tabComplete(e){return await(new J).tabComplete(e)}async _run(e){const{history:t,stdout:s}=e,n=(new J).parse(e.args);return n.help.isSet?n.writeHelp(s):n.clear.isSet?t.clear():t.write(s),x.y.SUCCESS}}class Z extends b.k{description="Locate built-in commands by name. Prints each given command if it exists, otherwise an error message.";help=new S.C8("h","help","display this help and exit");positional=new S.Tl({tabComplete:async e=>({possibles:e.commandRegistry?.commandNames()??[]})})}class ee extends y{get name(){return"which"}async tabComplete(e){return await(new Z).tabComplete(e)}async _run(e){const{args:t,stdout:s}=e,n=new Set(e.commandRegistry?.commandNames()),i=(new Z).parse(e.args);if(i.help.isSet)return i.writeHelp(s),x.y.SUCCESS;if(0===i.positional.strings.length)return s.write("which: missing operand\n"),i.writeHelp(s),x.y.GENERAL_ERROR;let r=x.y.SUCCESS;for(const s of t)n.has(s)?e.stdout.write(`${s}\n`):(e.stdout.write(`which: no ${s} command\n`),r=x.y.GENERAL_ERROR);return r}}class te{callExternalCommand;callExternalTabComplete;constructor(e,t){this.callExternalCommand=e,this.callExternalTabComplete=t,this.registerBuiltinCommands(n)}allModules(){const e=[];for(const t of this.commandPackageMap.values())e.push(...t.modules);return e.sort((e,t)=>e.name<t.name?-1:1),e}commandNames(e=p.All){return e===p.None?[]:e===p.All?Array.from(this._map.keys()).sort():Array.from(this._map).filter(([t,s])=>(s.commandType&e)>0).map(([e,t])=>e).sort()}get(e){return this._map.get(e)??null}match(e,t=p.All){return this.commandNames(t).filter(t=>t.startsWith(e))}registerBuiltinCommands(e){for(const[t,s]of Object.entries(e))if(t.endsWith("Command")&&!t.startsWith("Builtin"))try{const e=new s;e instanceof y&&this._register(e)}catch{}}registerCommandPackage(e){this.commandPackageMap.set(e.name,e);for(const t of e.modules)this._register(t.runner)}registerExternalCommand(e,t){this._map.set(e,new w(e,this.callExternalCommand,t?this.callExternalTabComplete:void 0))}_register(e){for(const t of e.names())this._map.set(t,e)}_map=new Map;commandPackageMap=new Map}class se{module;constructor(e){this.module=e}get moduleName(){return this.module.moduleName}names(){return this.module.names}get packageName(){return this.module.packageName}}var ne=s(1203);class ie extends se{module;constructor(e){super(e),this.module=e}get commandType(){return p.JavaScript}async run(e){const{name:t}=e,s=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0===s)throw new C.xZ(t);if(!Object.prototype.hasOwnProperty.call(s,"run"))throw new C.C2(t);const{args:n,environment:i,fileSystem:r,shellId:a,stdout:o,stderr:l,termios:c}=e,h={name:t,args:n,environment:i,fileSystem:r,shellId:a,stdin:new ne._(e.stdin),stdout:o,stderr:l,termios:c};try{return await s.run(h)}catch(e){throw console.error(`JavascriptCommandRunner: ${e}`),new C.T6(t)}}async tabComplete(e){const t=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0!==t&&Object.prototype.hasOwnProperty.call(t,"tabComplete")&&void 0!==t.tabComplete){const{name:s,args:n,shellId:i}=e;try{return await t.tabComplete({name:s,args:n,shellId:i})}catch(e){}}return{}}}class re extends se{module;constructor(e){super(e),this.module=e}get commandType(){return p.Wasm}async run(e){const{name:t,args:s,workerIO:n,fileSystem:i,stdin:r,stdout:a,stderr:o,termios:c}=e,{wasmBaseUrl:h}=this.module.loader,u=Date.now(),d=this.module.loader.getWasmModule(this.packageName,this.moduleName);if(void 0===d)throw new C.xZ(t);function m(e){return c.get()}function p(e,t,s){return c.set(s),0}function f(t){return[e.environment.getNumber("LINES")??24,e.environment.getNumber("COLUMNS")??80]}function _(e,t){return n.poll(t)}function g(e,t,s,n,i){if(0===n)return 0;let a=r.read(n);return 1===a.length&&4===a[0]&&(a=[]),t.set(a,s),a.length}function w(e,i,r,l,c){if(0===l)return 0;const h=i.slice(r,r+l),u=n.utf8ArrayToString(h),d="/dev/tty1"===e.path;return d&&"touch"===t&&s.length>1||(d?o:a).write(u),l}let y;function S(e){void 0===y&&(y=e)}const b=await d({thisProgram:t,arguments:s,locateFile:e=>(0,l.oq)(h,this.packageName+"/"+e),onExit:e=>S(e),quit:(e,t)=>S(e),preRun:[t=>{if(Object.prototype.hasOwnProperty.call(t,"FS")){const e=t.FS,{mountpoint:s}=i;e.mkdir(s,511),e.mount(i.PROXYFS,{root:s,fs:i.FS},s),e.chdir(i.FS.cwd())}Object.prototype.hasOwnProperty.call(t,"ENV")&&e.environment.copyIntoCommand(t.ENV,a.supportsAnsiEscapes()),Object.prototype.hasOwnProperty.call(t,"TTY")&&(t.TTY.default_tty_ops.ioctl_tcgets=m,t.TTY.default_tty_ops.ioctl_tcsets=p,t.TTY.default_tty_ops.ioctl_tiocgwinsz=f,t.TTY.stream_ops.poll=_,t.TTY.stream_ops.read=g,t.TTY.stream_ops.write=w)}],stderr:this._outputHandler(o),stdout:this._outputHandler(a)});if(void 0===y)y=x.y.CANNOT_RUN_COMMAND;else{if(Object.prototype.hasOwnProperty.call(b,"FS")){const e=b.FS;for(const t of[e.streams[1],e.streams[2]])null===t||e.isClosed(t)||e.close(t)}Object.prototype.hasOwnProperty.call(b,"getEnvStrings")&&e.environment.copyFromCommand(b.getEnvStrings())}const k=Date.now();return console.debug(`Cockle ${t} load and run time ${k-u} ms`),y}_outputHandler(e){if(!e.supportsAnsiEscapes())return t=>e.write(String.fromCharCode(t))}}class ae{commandModuleLoader;name;commands;packageName;wasm;constructor(e,t,s,n,i){this.commandModuleLoader=e,this.name=t,this.commands=s,this.packageName=n,this.wasm=i}get loader(){return this.commandModuleLoader}get runner(){return void 0===this._runner&&(this._runner=this.wasm?new re(this):new ie(this)),this._runner}get moduleName(){return this.name}get names(){return this.commands}_runner}class oe{name;version;build_string;channel;platform;wasm;modules;constructor(e,t,s,n,i,r,a){this.name=e,this.version=t,this.build_string=s,this.channel=n,this.platform=i,this.wasm=r,this.modules=a}}class le extends Map{constructor(e){super(),e?(this.set("PS1",a.Q.styleGreen+"js-shell:"+a.Q.styleReset+" "),this.set("TERM","xterm-256color"),this.set("TERMINFO","/usr/local/share/terminfo")):this.set("PS1","js-shell: ")}copyFromCommand(e){for(const t of e){const e=t.split("="),s=e.shift();s&&!this._ignore.has(s)&&this.set(s,e.join("="))}}copyIntoCommand(e,t){for(const[s,n]of this.entries())(t||"TERM"!==s)&&(e[s]=n)}getNumber(e){const t=this.get(e);if(null===t)return null;const s=Number(t);return isNaN(s)?null:s}getPrompt(){return this.get("PS1")??"$ "}get color(){return this.has("TERM")}_ignore=new Set(["USER","LOGNAME","HOME","LANG","_"])}class ce{add(e){this._current=null,!e.trim()||this._ignoreInitialWhitespace&&e.startsWith(" ")||this._ignoreDuplicates&&e===this.at(-1)||(this._history.length>=this._maxSize&&this._history.shift(),this._history.push(e))}at(e){return this._history.at(e)??null}clear(){this._current=null,this._history=[]}scrollCurrent(e){return this._current=e?null===this._current?null:this._current+1:null===this._current?this._history.length-1:this._current-1,null!==this._current&&(this._current<0?this._current=0:this._current>=this._history.length&&(this._current=null)),null===this._current?null:this.at(this._current)}setMaxSize(e){this._maxSize=Math.max(e,0),this._history.length>this._maxSize&&(this._current=null,this._history=this._history.slice(this._maxSize))}write(e){for(let t=0;t<this._history.length;t++){const s=String(t).padStart(5," ");e.write(`${s}  ${this._history[t]}\n`)}}_history=[];_current=null;_ignoreInitialWhitespace=!0;_ignoreDuplicates=!0;_maxSize=1e3}var he,ue=s(7703),de=s(8316),me=s(4207),pe=s(5981),fe=s(2958),_e=s(312),ge=s(2251),Ce=s(7497);class we{context;constructor(e){this.context=e}async complete(e){const t=e.text.slice(0,e.cursorIndex),s=e.text.slice(e.cursorIndex),n=(0,Ce.qg)(t,!1).at(-1),[i,r]=t.endsWith(" ")?[null,!1]:void 0!==n?n.lastToken():[null,!0];let o=i?.value??"",c={pathType:A.y.Any};if(r)c={possibles:this._getPossibleCompletionsCommand(o)};else if(n instanceof Ce.Sv){const e=n,t=e.name.value,s=this.context.commandRegistry.get(t);if(null!==s&&void 0!==s.tabComplete){const n=e.suffix.map(e=>e.value);o||n.push("");const{commandRegistry:i,stdinContext:r}=this.context;c=await s.tabComplete({name:t,args:n,commandRegistry:i,shellId:this.context.shellId,stdinContext:r})}}const h=c.possibles??[];if(void 0!==c.pathType){let t=[];[e,o,t]=this._getPossibleCompletionsFileSystem(e,o,c.pathType),h.push(...t)}if(0===h.length)return e;if(h.sort(),1===h.length){let t=h[0].slice(o.length);return t.endsWith("/")||(t+=" "),e.text=e.text.slice(0,e.cursorIndex)+t+s,e.cursorIndex+=t.length,this.context.workerIO.write(t+s+a.Q.cursorLeft(s.length)),e}const u=(0,l.Il)(h,o.length);if(u.length>o.length){const t=u.slice(o.length);return e.text=e.text.slice(0,e.cursorIndex)+t+s,e.cursorIndex+=t.length,this.context.workerIO.write(t+s+a.Q.cursorLeft(s.length)),e}return await this._showPossibleCompletions(e,s,h),e}_getPossibleCompletionsCommand(e){const t=this.context.commandRegistry.match(e),s=this.context.aliases.match(e);return[...new Set([...t,...s])]}_getPossibleCompletionsFileSystem(e,t,s){const{FS:n,PATH:i}=this.context.fileSystem;t||(t="./");const r=t.endsWith("/"),a=[void 0,"/"],o=t.endsWith("..")&&a.includes(t.at(-3)),l=!o&&t.endsWith(".")&&a.includes(t.at(-2)),c=l||o;o&&(t=t.slice(0,-1));const h=n.analyzePath(t,!0),u=r||c?h.path:h.parentPath,d=c?l?".":"..":r?"":h.name;let m=n.readdir(u);r&&(m=m.filter(e=>!e.startsWith("."))),m=m.filter(e=>e.startsWith(d));const p=new ye(n);return s===A.y.Directory?m=m.filter(e=>p.isDir(i.join(u,e))):s===A.y.File&&(m=m.filter(e=>p.isFile(i.join(u,e)))),s!==A.y.File&&(m=m.map(e=>p.isDir(i.join(u,e))?e+"/":e)),[e,d,m]}async _showPossibleCompletions(e,t,s){const{environment:n}=this.context,i=`\n${(0,l.tp)(s,n.getNumber("COLUMNS")??0).join("\n")}\n${n.getPrompt()}${e.text}`;this.context.workerIO.write(i+a.Q.cursorLeft(t.length))}}class ye{FS;constructor(e){this.FS=e}isDir(e){return this.FS.isDir(this._stat(e).mode)}isFile(e){return this.FS.isFile(this._stat(e).mode)}_stat(e){let t=this._statCache.get(e);return void 0===t&&(t=this.FS.stat(e,!1),this._statCache.set(e,t)),t}_statCache=new Map}class Se{constructor(e){this._options=e,this._commandModuleLoader=new g(e.wasmBaseUrl,e.downloadModuleCallback),this._fileSystem={FS:void 0,PATH:void 0,ERRNO_CODES:void 0,PROXYFS:void 0,mountpoint:e.mountpoint??"/drive"};const t=e.workerIO;this._runContext={name:"",args:[],fileSystem:this._fileSystem,aliases:new f.D,commandRegistry:new te(e.callExternalCommand,e.callExternalTabComplete),environment:new le(e.color),history:new ce,shellId:e.shellId,terminate:this.terminate.bind(this),stdin:this._dummyInput,stdout:this._dummyOutput,stderr:this._dummyOutput,termios:e.termios,workerIO:t,commandModuleCache:this._commandModuleLoader.cache,stdinContext:e.stdinContext},Object.entries(e.aliases).forEach(([e,t])=>this._runContext.aliases.set(e,t)),Object.entries(e.environment).forEach(([e,t])=>{void 0===t?this._runContext.environment.delete(e):this._runContext.environment.set(e,t)}),e.externalCommandConfigs.forEach(e=>this._runContext.commandRegistry.registerExternalCommand(e.name,e.hasTabComplete)),this._stderr=new ue.m(this.output.bind(this),this._options.color?a.Q.styleRed:void 0,this._options.color?a.Q.styleReset:void 0),this._tabCompleter=new we(this._runContext)}get aliases(){return this._runContext.aliases}get environment(){return this._runContext.environment}get exitCode(){return this._exitCode}async externalInput(e){const t=await this._runContext.stdin.readAsync(e);return String.fromCharCode(...t)}externalOutput(e,t){(t?this._runContext.stderr:this._runContext.stdout).write(e)}get history(){return this._runContext.history}async initialize(){await this._initWasmPackages(),await this._initFileSystem()}async input(e){if(!this._isRunning)return;const t=e.length;for(let s=0;s<t;++s){const t=e[s];switch(t.charCodeAt(0)){case 13:{this.output("\n");const e=this._commandLine.text;this._commandLine.text="",this._commandLine.cursorIndex=0,e.length>0&&await this._runCommands(e),await this._outputPrompt();break}case 127:if(this._commandLine.cursorIndex>0){const{cursorIndex:e,text:t}=this._commandLine,s=t.slice(e);this._commandLine.text=t.slice(0,e-1)+s,this._commandLine.cursorIndex--,this.output(a.Q.cursorLeft(1)+s+a.Q.eraseEndLine+a.Q.cursorLeft(s.length))}break;case 9:this._commandLine=await this._tabCompleter.complete(this._commandLine);break;case 27:s+=this._escapedInput(e,s);break;case 4:break;default:if(this._commandLine.cursorIndex===this._commandLine.text.length)this._commandLine.text+=t,this.output(t);else{const{cursorIndex:e,text:s}=this._commandLine,n=s.slice(e);this._commandLine.text=s.slice(0,e)+t+n,this.output(a.Q.eraseEndLine+t+n+a.Q.cursorLeft(n.length))}this._commandLine.cursorIndex++}}}output(e){this._isRunning&&this._runContext.workerIO.write(e)}async setSize(e,t){const{environment:s}=this;if(e>=1){const t=e.toString();s.set("LINES",t),s.set("LESS_LINES",t)}else s.delete("LINES"),s.delete("LESS_LINES");if(t>=1){const e=t.toString();s.set("COLUMNS",e),s.set("LESS_COLUMNS",e)}else s.delete("COLUMNS"),s.delete("LESS_COLUMNS")}setWorkerIO(e){this._runContext.workerIO=e}async start(){this._isRunning=!0,await this._outputPrompt()}terminate(){console.log("Cockle ShellImpl.terminate"),this._isRunning=!1,this._options.terminateCallback()}async themeChange(e){this._requestedDarkMode=e,this._themeStatus===he.Ok&&(this._themeStatus=he.PendingChange,this._runContext.workerIO.enabled||await this._handleThemeChange())}_escapedInput(e,t){if("["!==e.at(t+1))return 0;const s=/^[^A-Z~]*[A-Z~]/.exec(e.slice(t+2));if(null===s)return 1;const n=s[0];switch(n){case"A":case"1A":case"B":case"1B":{const e=this.history.scrollCurrent(n.endsWith("B"));this._commandLine.text=null!==e?e:"",this._commandLine.cursorIndex=this._commandLine.text.length,this.output(a.Q.eraseEndLine+a.Q.eraseStartLine+`\r${this.environment.getPrompt()}${this._commandLine.text}`);break}case"D":case"1D":this._commandLine.cursorIndex>0&&(this._commandLine.cursorIndex--,this.output(a.Q.cursorLeft()));break;case"C":case"1C":this._commandLine.cursorIndex<this._commandLine.text.length&&(this._commandLine.cursorIndex++,this.output(a.Q.cursorRight()));break;case"3~":if(this._commandLine.cursorIndex<this._commandLine.text.length){const{cursorIndex:e,text:t}=this._commandLine,s=t.slice(e+1);this._commandLine.text=t.slice(0,e)+s,this.output(a.Q.eraseEndLine+s+a.Q.cursorLeft(s.length))}break;case"H":case"1;2H":this._commandLine.cursorIndex>0&&(this.output(a.Q.cursorLeft(this._commandLine.cursorIndex)),this._commandLine.cursorIndex=0);break;case"F":case"1;2F":{const{length:e}=this._commandLine.text;this._commandLine.cursorIndex<e&&(this.output(a.Q.cursorRight(e-this._commandLine.cursorIndex)),this._commandLine.cursorIndex=e);break}case"1;2D":case"1;5D":if(this._commandLine.cursorIndex>0){const{cursorIndex:e,text:t}=this._commandLine,s=t.slice(0,e).trimEnd().lastIndexOf(" ")+1;this.output(a.Q.cursorLeft(e-s)),this._commandLine.cursorIndex=s}break;case"1;2C":case"1;5C":{const{length:e}=this._commandLine.text;if(this._commandLine.cursorIndex<e-1){const{cursorIndex:t,text:s}=this._commandLine,n=s.slice(t),i=n.trimStart(),r=i.indexOf(" "),o=r<0?e:t+n.length-i.length+r;this.output(a.Q.cursorRight(o-t)),this._commandLine.cursorIndex=o}break}default:console.warn(`Unrecognised escape sequence '[${n}'`)}return n.length+1}_filenameExpansion(e){const{PATH:t}=this._runContext.fileSystem;let s=[],n=0;for(const i of e){if(i.startsWith("-")){n++,s.push(i);continue}if(!i.includes("*")&&!i.includes("?")){s.push(i);continue}const{FS:e}=this._runContext.fileSystem,r=e.analyzePath(i,!1);if(!r.parentExists){s.push(i);continue}const a=r.parentPath;let o=a;const l=e.cwd();o.startsWith(l)&&(o=o.slice(l.length),o.startsWith("/")&&(o=o.slice(1)));let c=e.readdir(a),h=r.name.replace(/[.+^${}()|[\]\\]/g,"\\$&");h=h.replaceAll("*",".*"),h=h.replaceAll("?",".");const u=new RegExp(`^${h}$`);c=c.filter(e=>e.match(u)),c=c.filter(e=>!e.startsWith(".")),o.length>0&&(c=c.map(e=>t.join(o,e))),s=s.concat(c)}return s.length===n&&(s=e),s}async _handleThemeChange(){if(this._themeStatus===he.Changing)return;if(void 0!==this._requestedDarkMode)return void this._setDarkMode(this._requestedDarkMode);this._themeStatus=he.Changing,await this._options.enableBufferedStdinCallback(!0);const{termios:e,workerIO:t}=this._options;e.setRawMode(),this.output("]11;?");const s=Date.now(),n=await t.readAsync(null,100);console.debug("Cockle theme change",Date.now()-s,"ms"),e.setDefaultShell(),await this._options.enableBufferedStdinCallback(!1),this._themeStatus=he.Ok;const i=String.fromCharCode(...n),r=/^\x1b]11;rgb:([0-9A-Fa-f]{2,})\/([0-9A-Fa-f]{2,})\/([0-9A-Fa-f]{2,})\x1b\\$/.exec(i);if(r){const e=(parseInt(r[1].slice(0,2),16)/255+parseInt(r[2].slice(0,2),16)/255+parseInt(r[3].slice(0,2),16)/255)/3;this._setDarkMode(e<.6)}else console.warn("Unable to determine terminal background color"),this._setDarkMode(void 0)}async _initFileSystem(){const{wasmBaseUrl:e}=this._options,t=this._commandModuleLoader.getWasmModule("cockle_fs","fs");if(void 0===t)return void console.error("Unable to load cockle_fs, shell cannot function");const s=await t({locateFile:t=>(0,l.oq)(e,"cockle_fs/"+t)}),{FS:n,PATH:i,ERRNO_CODES:r,PROXYFS:a}=s,o=this._fileSystem.mountpoint;n.mkdirTree(o,511),this._runContext.fileSystem.FS=n,this._runContext.fileSystem.PATH=i,this._runContext.fileSystem.ERRNO_CODES=r,this._runContext.fileSystem.PROXYFS=a;const{browsingContextId:c,baseUrl:h,initialDirectories:u,initialFiles:d}=this._options;this._options.initDriveFSCallback({browsingContextId:c,baseUrl:h,fileSystem:this._runContext.fileSystem,mountpoint:o}),n.chdir(o),this.environment.set("PWD",n.cwd()),u&&u.forEach(e=>n.mkdir(e,509)),d&&Object.entries(d).forEach(([e,t])=>n.writeFile(e,t,{mode:436}))}async _initWasmPackages(){const e=(0,l.oq)(this._options.wasmBaseUrl,"cockle-config.json"),t=await fetch(e);t.ok||console.error(`Failed to fetch ${e}, terminal cannot function without it`);const s=await t.json(),n=Object.keys(s.packages),i="cockle_fs";n.includes(i)||console.error(`cockle-config.json does not include required package '${i}'`);for(const e of n){const t=s.packages[e],n=Object.entries(t.modules).map(([s,n])=>new ae(this._commandModuleLoader,s,n.commands?n.commands.split(","):[],e,t.wasm)),i=new oe(e,t.version,t.build_string,t.channel,t.platform,t.wasm,n);this._runContext.commandRegistry.registerCommandPackage(i)}if(Object.hasOwn(s,"aliases"))for(const[e,t]of Object.entries(s.aliases)){const s=t;s.length>0&&this.aliases.set(e,s)}if(Object.hasOwn(s,"environment"))for(const[e,t]of Object.entries(s.environment)){const s=t;s.length>0&&this.environment.set(e,s)}}async _outputPrompt(){this._isRunning&&(this._themeStatus===he.PendingChange&&await this._handleThemeChange(),this._runContext.workerIO.write(`\n${this.environment.getPrompt()}`))}async _runCommands(e){if(e.startsWith("!")){const t=parseInt(e.slice(1)),s=this.history.at(t);if(null===s){let e="!"+t+": event not found";return this._options.color&&(e=a.Q.styleBoldRed+e+a.Q.styleReset),this.output(`${e}\n`),void await this._outputPrompt()}e=s}let t;await this._options.enableBufferedStdinCallback(!0),this._options.termios.setDefaultWasm(),this.history.add(e);const s=new de.d(this._stdinCallback.bind(this),this._stdinAsyncCallback.bind(this)),n=new ue.m(this.output.bind(this)),i=this._stderr;try{const r=(0,Ce.qg)(e,!0,this.aliases);for(const e of r)if(e instanceof Ce.Sv)t=await this._runCommand(e,s,n,i);else{if(!(e instanceof Ce.Ru))throw new C.$g(`Expected CommandNode or PipeNode not ${e}`);{const{commands:t}=e,r=t.length;let a;for(let e=0;e<r;e++){const o=0===e?s:a.input,l=e<r-1?a=new me.n:n;await this._runCommand(t[e],o,l,i)}}}}catch(e){e instanceof C.Ge&&(t=e.exitCode),i.write(e+"\n"),i.flush()}finally{t=t??x.y.GENERAL_ERROR,this._setExitCode(t),this._options.termios.setDefaultShell(),await this._options.enableBufferedStdinCallback(!1)}}async _runCommand(e,t,s,n){const i=e.name.value,r=this._runContext.commandRegistry.get(i);if(null===r)throw new C.xZ(i);if(e.redirects){if(e.redirects.length>1)throw new C.$g("Only implemented a single redirect per command");const n=e.redirects[0],i=n.token.value,r=n.target.value;if(">"===i||">>"===i)s=new pe.M(this._runContext.fileSystem,r,">>"===i);else{if("<"!==i)throw new C.$g("Unrecognised redirect "+i);t=new fe.z(this._runContext.fileSystem,r)}}let a=e.suffix.map(e=>e.value);a=this._filenameExpansion(a),this._runContext.name=i,this._runContext.args=a,this._runContext.stdin=t,this._runContext.stdout=s,this._runContext.stderr=n;let o=-1;try{o=await r.run(this._runContext)}finally{n.flush(),s.flush(),this._runContext.name="",this._runContext.args=[],this._runContext.stdin=this._dummyInput,this._runContext.stdout=this._dummyOutput,this._runContext.stderr=this._dummyOutput}return o}_setDarkMode(e){if(e===this._darkMode)return;if(this._darkMode=e,this._options.color){this._stderr.prefix=e?a.Q.styleBrightRed:a.Q.styleRed;const t=e?a.Q.styleBoldGreen:a.Q.styleGreen;this._runContext.environment.set("PS1",t+"js-shell:"+a.Q.styleReset+" ")}const t="COCKLE_DARK_MODE";void 0===e?this.environment.delete(t):this.environment.set(t,e?"1":"0")}_setExitCode(e){this._exitCode=e,this.environment.set("?",`${e}`)}_stdinCallback(e){return this._runContext.workerIO.read(e)}async _stdinAsyncCallback(e){return await this._runContext.workerIO.readAsync(e,0)}_commandLine={text:"",cursorIndex:0};_darkMode;_exitCode=0;_requestedDarkMode;_isRunning=!1;_themeStatus=he.PendingChange;_commandModuleLoader;_runContext;_dummyInput=new _e.X;_dummyOutput=new ge.y;_fileSystem;_options;_stderr;_tabCompleter}!function(e){e[e.Ok=0]="Ok",e[e.PendingChange=1]="PendingChange",e[e.Changing=2]="Changing"}(he||(he={}));class be{async initialize(e,t,s,n,i,r,a,o){if(this._stdinContext=new m(a,this._setWorkerIO.bind(this)),e.supportsServiceWorker&&(this._serviceWorkerWorkerIO=new h(r,this._termios,e.baseUrl??"",e.browsingContextId??"",e.shellId),this._stdinContext.setAvailable("sw",!0)),void 0!==e.sharedArrayBuffer&&(this._sharedArrayBufferWorkerIO=new d(r,this._termios,e.sharedArrayBuffer),this._stdinContext.setAvailable("sab",!0)),this._workerIO=this._sharedArrayBufferWorkerIO??this._serviceWorkerWorkerIO,void 0===this._workerIO)throw new Error("ABORT: does not support SharedArrayBuffer or ServiceWorker!");this._stdinContext.setEnabled(this._workerIO===this._sharedArrayBufferWorkerIO?"sab":"sw"),this._downloadModuleCallback=n,this._enableBufferedStdinCallback=i,this._terminateCallback=o,this._shellImpl=new Se({shellId:e.shellId,color:e.color,mountpoint:e.mountpoint,baseUrl:e.baseUrl,wasmBaseUrl:e.wasmBaseUrl,browsingContextId:e.browsingContextId,aliases:e.aliases,environment:e.environment,externalCommandConfigs:e.externalCommandConfigs,initialDirectories:e.initialDirectories,initialFiles:e.initialFiles,callExternalCommand:t,callExternalTabComplete:s,downloadModuleCallback:this._downloadModuleCallback.bind(this),enableBufferedStdinCallback:this.enableBufferedStdin.bind(this),initDriveFSCallback:this.initDriveFS.bind(this),terminateCallback:this._terminateCallback.bind(this),workerIO:this._workerIO,stdinContext:this._stdinContext,termios:this._termios}),await this._shellImpl.initialize()}async enableBufferedStdin(e){e?(await(this._workerIO?.canEnable()),this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(!0),await(this._workerIO?.enable())):(this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(!1),await(this._workerIO?.disable()))}get exitCode(){return this._shellImpl?.exitCode??1}async externalInput(e){return this._shellImpl.externalInput(e)}externalOutput(e,t){this._shellImpl?.externalOutput(e,t)}externalSetTermios(e){this._termios.set(e)}async input(e){this._shellImpl&&await this._shellImpl.input(e)}async setSize(e,t){this._shellImpl&&await this._shellImpl.setSize(e,t)}async start(){this._shellImpl&&await this._shellImpl.start()}async themeChange(e){await(this._shellImpl?.themeChange(e))}_setWorkerIO(e){const t=this._workerIO;if("sab"===e&&void 0!==this._sharedArrayBufferWorkerIO)this._workerIO=this._sharedArrayBufferWorkerIO;else{if("sw"!==e||void 0===this._serviceWorkerWorkerIO)throw new Error(`Cannot set WorkerIO to '${e}'`);this._workerIO=this._serviceWorkerWorkerIO}t?.disable(),this._shellImpl?.setWorkerIO(this._workerIO)}_shellImpl;_downloadModuleCallback;_enableBufferedStdinCallback;_terminateCallback;_stdinContext;_serviceWorkerWorkerIO;_sharedArrayBufferWorkerIO;_termios=new o.G.Termios;_workerIO}},763:(e,t,s)=>{var n;s.d(t,{X:()=>n}),function(e){e.MAIN=0,e.WORKER=1,e.LENGTH=2,e.START=3,e.maxChars=64}(n||(n={}))},952:(e,t,s)=>{s.d(t,{J:()=>i});var n=s(1315);class i extends n.S{pipe;constructor(e){super(),this.pipe=e}readAll(){const e=this.pipe.allContent;return this.pipe.clear(),e}}},955:(e,t,s)=>{var n;s.d(t,{y:()=>n}),function(e){e[e.Any=0]="Any",e[e.Directory=1]="Directory",e[e.File=2]="File"}(n||(n={}))},1203:(e,t,s)=>{s.d(t,{_:()=>n});class n{input;constructor(e){this.input=e}isTerminal(){return this.input.isTerminal()}async readAsync(e){const t=await this.input.readAsync(e);return String.fromCharCode(...t)}}},1315:(e,t,s)=>{s.d(t,{S:()=>n});class n{isTerminal(){return!1}async readAsync(e){return this.read(e)}read(e){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const e=this._buffer[this._index++],t=[];for(let s=0;s<e.length;s++)t.push(e.charCodeAt(s));return t}return[]}_buffer;_index=0}},2251:(e,t,s)=>{s.d(t,{y:()=>n});class n{flush(){}supportsAnsiEscapes(){return!1}write(e){}}},2958:(e,t,s)=>{s.d(t,{z:()=>i});var n=s(1315);class i extends n.S{fileSystem;path;constructor(e,t){super(),this.fileSystem=e,this.path=t}readAll(){const{FS:e}=this.fileSystem;return e.readFile(this.path,{encoding:"utf8"})}}},3482:(e,t,s)=>{s.d(t,{y:()=>n});const n={SUCCESS:0,GENERAL_ERROR:1,IMPROPER_USE:2,CANNOT_RUN_COMMAND:126,CANNOT_FIND_COMMAND:127}},3694:(e,t,s)=>{s.d(t,{Z:()=>n});const n="1.2.0"},4133:(e,t,s)=>{var n;s.d(t,{G:()=>n}),function(e){let t,s,n,i;!function(e){e[e.ISTRIP=32]="ISTRIP",e[e.INLCR=64]="INLCR",e[e.IGNCR=128]="IGNCR",e[e.ICRNL=256]="ICRNL",e[e.IUCLC=512]="IUCLC",e[e.IXON=1024]="IXON",e[e.IXANY=2048]="IXANY",e[e.IMAXBEL=8192]="IMAXBEL",e[e.IUTF8=16384]="IUTF8"}(t=e.InputFlag||(e.InputFlag={})),function(e){e[e.OPOST=1]="OPOST",e[e.OLCUC=2]="OLCUC",e[e.ONLCR=4]="ONLCR",e[e.OCRNL=8]="OCRNL",e[e.ONOCR=16]="ONOCR",e[e.ONLRET=32]="ONLRET",e[e.TABDLY=6144]="TABDLY"}(s=e.OutputFlag||(e.OutputFlag={})),function(e){e[e.ISIG=1]="ISIG",e[e.ICANON=2]="ICANON",e[e.ECHO=8]="ECHO",e[e.ECHOE=16]="ECHOE",e[e.ECHOK=32]="ECHOK",e[e.ECHONL=64]="ECHONL",e[e.NOFLSH=128]="NOFLSH",e[e.ECHOCTL=512]="ECHOCTL",e[e.ECHOPRT=1024]="ECHOPRT",e[e.ECHOKE=2048]="ECHOKE",e[e.IEXTEN=32768]="IEXTEN"}(n=e.LocalFlag||(e.LocalFlag={})),function(e){e[e.VINTR=0]="VINTR",e[e.VQUIT=1]="VQUIT",e[e.VERASE=2]="VERASE",e[e.VKILL=3]="VKILL",e[e.VEOF=4]="VEOF",e[e.VTIME=5]="VTIME",e[e.VMIN=6]="VMIN",e[e.VSWTCH=7]="VSWTCH",e[e.VSTART=8]="VSTART",e[e.VSTOP=9]="VSTOP",e[e.VSUSP=10]="VSUSP",e[e.VEOL=11]="VEOL",e[e.VREPRINT=12]="VREPRINT",e[e.VDISCARD=13]="VDISCARD",e[e.VWERASE=14]="VWERASE",e[e.VLNEXT=15]="VLNEXT",e[e.VEOL2=16]="VEOL2"}(i=e.ControlCharacter||(e.ControlCharacter={})),e.cloneFlags=function(e){return{c_iflag:e.c_iflag,c_oflag:e.c_oflag,c_cflag:e.c_cflag,c_lflag:e.c_lflag,c_cc:[...e.c_cc]}};class r{c_iflag=0;c_oflag=0;c_cflag=0;c_lflag=0;c_cc=[]}e.Flags=r,e.Termios=class{constructor(){this.setDefaultShell()}get(){return this._flags}log(e){const i=(e,t,s)=>{const n=[];for(const[t,i]of Object.entries(e).filter(([e,t])=>e[0].match(/\D/)))(s&i)>0&&n.push(t);return`  ${t} = ${s} 0x${s.toString(16)} = ${n.join(" ")}`},r=["Cockle "+e+":"],a=this._flags;r.push(i(t,"c_iflag",a.c_iflag)),r.push(i(s,"c_oflag",a.c_oflag)),r.push(`  c_cflag = ${a.c_cflag} 0x${a.c_cflag.toString(16)}`),r.push(i(n,"c_lflag",a.c_lflag)),r.push(`  c_cc = ${a.c_cc}`),console.debug(r.join("\n"))}set(e){this._flags=e,this.log("Termios set")}setDefaultShell(){this.setDefaultWasm(),this._flags.c_oflag|=s.ONOCR}setDefaultWasm(){const e=this._flags;e.c_iflag=t.IUTF8|t.IMAXBEL|t.IXON|t.ICRNL,e.c_oflag=s.OPOST|s.ONLCR,e.c_cflag=191,e.c_lflag=n.IEXTEN|n.ECHOKE|n.ECHOCTL|n.ECHOK|n.ECHOE|n.ECHO|n.ICANON|n.ISIG,e.c_cc=[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}setRawMode(){const e=this._flags;e.c_iflag&=~(t.ISTRIP|t.INLCR|t.IGNCR|t.ICRNL|t.IXON),e.c_oflag&=~s.OPOST,e.c_lflag&=~(n.ECHO|n.ECHONL|n.ICANON|n.ISIG|n.IEXTEN)}_flags=new r}}(n||(n={}))},4207:(e,t,s)=>{s.d(t,{n:()=>r});var n=s(5670),i=s(952);class r extends n.j{flush(){}get input(){return new i.J(this)}}},5670:(e,t,s)=>{s.d(t,{j:()=>n});class n{get allContent(){return this.data.join("")}clear(){this.data=[]}supportsAnsiEscapes(){return!1}write(e){this.data.push(e)}data=[]}},5874:(e,t,s)=>{s.d(t,{k:()=>o,s:()=>l});var n=s(2199),i=s(7095),r=s(585),a=s(955);class o{parse(e){return this._parseToRun(e.slice()),this}async tabComplete(e){const t={...e,args:e.args.slice()},s=await this._parseToTabComplete(t);return s.possibles&&(s.possibles=s.possibles.filter(t=>t.startsWith(e.args.at(-1)))),s}writeHelp(e){for(const t of this._help())e.write(`${t}\n`)}_findByLongName(e){const t=this._longNameArguments;if(e in t)return t[e];throw new i.$g(`No such longName argument '${e}'`)}_findByShortName(e){const t=this._shortNameArguments;if(e in t)return t[e];throw new i.$g(`No such shortName argument '${e}'`)}*_help(){this.description&&(yield this.description);const e=new r.XI({spacerSize:3});for(const t of Object.values(this))if(t instanceof n.ef){const{longName:s,shortName:n}=t;if(s||n){let i=n?`-${n}`:"  ";s&&(i+=(n?", ":"  ")+`--${s}`),e.addRow([i,t.description])}}if(e.rowCount>0&&(yield"",yield"options:",yield*e.lines("    ")),void 0!==this.subcommands){const e=new r.XI({spacerSize:3});for(const t of Object.values(this.subcommands))e.addRow([t.name,t.description]);e.rowCount>0&&(yield"",yield"subcommands:",yield*e.lines("    "))}}get _longNameArguments(){const e=Object.values(this).filter(e=>e instanceof n.ef&&"longName"in e&&e.longName.length>0);return Object.fromEntries(e.map(e=>[e.longName,e]))}_parseToRun(e){const{positional:t}=this;let s=!1;const n=this.subcommands??{};let r=!0;for(;e.length>0;){const a=e.shift();if(r&&a in n){const t=n[a];t.set(),t.parse(e);break}if(a.startsWith("-")&&a.length>1){if(s)throw new i.$g("Cannot have named argument after positional arguments");if(a.startsWith("--")){const t=a.slice(2);e=this._findByLongName(t).parse(a,e)}else{const t=a.slice(1);e=this._findByShortName(t).parse(a,e)}}else{if(void 0===t)throw new i.$g(`Unrecognised argument: '${a}'`);s=!0,e=t.parse(a,e)}r=!1}if(void 0!==t){const{min:e,max:s}=t.options;if(void 0!==e&&t.length<e)throw new i.$g("Insufficient positional arguments");if(void 0!==s&&t.length>s)throw new i.$g("Too many positional arguments")}}async _parseToTabComplete(e){let{args:t}=e;const{positional:s}=this,i=this.subcommands??{};let r=!0;for(;t.length>0;){const o=t.shift(),l=0===t.length;if(r&&i){if(l){const e=Object.keys(i).filter(e=>e.startsWith(o));if(e.length>0)return{possibles:e}}if(o in i){const t=i[o];return t.set(),await t.tabComplete(e)}}if(o.startsWith("-")){if(l){const e=Object.keys(this._longNameArguments).map(e=>"--"+e);return o.startsWith("--")?{possibles:e}:{possibles:Object.keys(this._shortNameArguments).map(e=>"-"+e).concat(e)}}if(o.startsWith("--")){const e=o.slice(2);t=this._findByLongName(e).parse(o,t)}else{const e=o.slice(1);t=this._findByShortName(e).parse(o,t)}}else if(void 0!==s){if(s instanceof n.ET)return{pathType:s.options.pathType??a.y.Any};{const n=s.options.tabComplete;if(void 0!==n)return await n({...e,args:[o,...t]})}}r=!1}return{}}get _shortNameArguments(){const e=Object.values(this).filter(e=>e instanceof n.ef&&"shortName"in e&&e.shortName.length>0);return Object.fromEntries(e.map(e=>[e.shortName,e]))}positional;subcommands;description}class l extends o{name;description;constructor(e,t){super(),this.name=e,this.description=t}get isSet(){return this._isSet}set(){this._isSet=!0}_isSet=!1}},5981:(e,t,s)=>{s.d(t,{M:()=>i});var n=s(5670);class i extends n.j{fileSystem;path;append;constructor(e,t,s){super(),this.fileSystem=e,this.path=t,this.append=s}flush(){const{FS:e}=this.fileSystem;let t=this.allContent;if(this.append)try{t=e.readFile(this.path,{encoding:"utf8"})+t}catch(e){}e.writeFile(this.path,t,{mode:436}),this.clear()}}},7095:(e,t,s)=>{s.d(t,{$g:()=>o,C2:()=>a,Ge:()=>i,T6:()=>l,xZ:()=>r});var n=s(3482);class i extends Error{exitCode;constructor(e,t){super(t),this.exitCode=e}}class r extends i{constructor(e){super(n.y.CANNOT_FIND_COMMAND,`'${e}': command not found`)}}class a extends i{constructor(e){super(n.y.CANNOT_FIND_COMMAND,`'${e}': cannot load command`)}}class o extends i{constructor(e){super(n.y.GENERAL_ERROR,e)}}class l extends i{constructor(e){super(n.y.CANNOT_RUN_COMMAND,`'${e}': cannot run command`)}}},7450:(e,t,s)=>{s.d(t,{D:()=>n});class n extends Map{constructor(){super()}getRecursive(e){let t=this.get(e);for(;void 0!==t;){const s=t.split(" ")[0];if(s===e)break;const n=this.get(s);if(void 0===n)return t;t=n+t.slice(s.length),e=s}return t}match(e){return[...this.keys()].filter(t=>t.startsWith(e))}}},7497:(e,t,s)=>{s.d(t,{Ru:()=>l,Sv:()=>o,qg:()=>h});var n=s(7095),i=s(9685);const r=";&";class a{}class o extends a{name;suffix;redirects;constructor(e,t,s){super(),this.name=e,this.suffix=t,this.redirects=s}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class l extends a{commands;constructor(e){super(),this.commands=e}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class c extends a{token;target;constructor(e,t){super(),this.token=e,this.target=t}lastToken(){return[this.target,!1]}}function h(e,t=!0,s){const n=(0,i.q)(e,t,s),a=[],o=[];let c=-1;const h=n.length;function d(){1===o.length?a.push(o[0]):o.length>1&&a.push(new l([...o])),o.length=0}for(let e=0;e<h;e++){const t=n[e];c>=0?r.includes(t.value)?(o.push(u(n.slice(c,e))),d(),c=-1):"|"===t.value&&(o.push(u(n.slice(c,e))),c=-1):r.includes(t.value)||(c=e)}return c>=0&&o.push(u(n.slice(c,h))),d(),a}function u(e){let t=e.slice(1);const s=t.findIndex(e=>{return(t=e.value).startsWith(">")||t.startsWith("<");var t});if(s>=0){if(t.length!==s+2)throw new n.$g("Redirect should be followed by file to redirect to");const i=new c(t[s],t[s+1]);return t=t.slice(0,s),new o(e[0],t,[i])}return new o(e[0],t)}},7703:(e,t,s)=>{s.d(t,{m:()=>n});class n{outputCallback;constructor(e,t,s){this.outputCallback=e,this.prefix=t,this.suffix=s}flush(){}supportsAnsiEscapes(){return!0}write(e){e.length<1||(void 0!==this.prefix&&(e=this.prefix+e),void 0!==this.suffix&&(e+=this.suffix),this.outputCallback(e))}prefix;suffix}},8301:(e,t,s)=>{s.d(t,{F:()=>r});var n,i=s(3291);!function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(n||(n={}));class r{browsingContextId;shellId;constructor(e,t,s){this.browsingContextId=t,this.shellId=s,this._url=(0,i.oq)(e,"api/stdin/terminal")}getStdin(e){try{const{xhr:t,msg:s}=this._prepareStdinRequest(e,n.SYNC);return t.send(s),this._processStdinReply(t.responseText)}catch(e){return console.error(`Failed to request stdin via service worker: ${e}`),""}}async getStdinAsync(e,t=!1){try{const{xhr:s,msg:i}=this._prepareStdinRequest(e,n.ASYNC,t),r=new Promise((e,t)=>{s.onload=()=>e(s.responseText),s.onerror=()=>t("XHR error")});return s.send(i),this._processStdinReply(await r)}catch(e){return console.error(`Failed to request stdin via service worker: ${e}`),""}}_prepareStdinRequest(e,t,s=!1){const i=new XMLHttpRequest;i.open("POST",this._url,t===n.ASYNC);const r={shellId:this.shellId,timeoutMs:e};return s&&(r.test=!0),{xhr:i,msg:JSON.stringify({browsingContextId:this.browsingContextId,data:r})}}_processStdinReply(e){const t=JSON.parse(e);if("error"in t)throw new Error(t.error);if(void 0!==t.text)return t.text??"";throw new Error(`Invalid stdin response: ${t}`)}_url}},8316:(e,t,s)=>{s.d(t,{d:()=>n});class n{stdinCallback;stdinAsyncCallback;constructor(e,t){this.stdinCallback=e,this.stdinAsyncCallback=t}isTerminal(){return!0}async readAsync(e){return await this.stdinAsyncCallback(e)}read(e){return this.stdinCallback(e)}}},9399:(e,t,s)=>{s.d(t,{Q:()=>r});const n="[";function i(e){return Math.min(Math.max(Math.round(e),0),255)}const r={enableAlternativeBuffer:"[?1049h",disableAlternativeBuffer:"[?1049l",cursorUp:(e=1)=>e>0?n+e+"A":"",cursorDown:(e=1)=>e>0?n+e+"B":"",cursorRight:(e=1)=>e>0?n+e+"C":"",cursorLeft:(e=1)=>e>0?n+e+"D":"",cursorHome:"[H",eraseScreen:"[2J",eraseSavedLines:"[3J",eraseEndLine:"[K",eraseStartLine:"[1K",styleRGB:(e,t,s,r=!0)=>`${n}${r?"38":"48"};2;${i(e)};${i(t)};${i(s)}m`,styleReset:"[1;0m",styleBoldRed:"[1;31m",styleBoldGreen:"[1;32m",styleBrightRed:"[0;91m",styleBrightGreen:"[0;92m",styleBrightYellow:"[0;93m",styleBrightBlue:"[0;94m",styleBrightPurple:"[0;95m",styleBrightCyan:"[0;96m",styleRed:"[0;31m",styleGreen:"[0;32m",styleYellow:"[0;33m",styleBlue:"[0;34m",stylePurple:"[0;35m",styleCyan:"[0;36m",showCursor:"[?25h",hideCursor:"[?25l"}},9685:(e,t,s)=>{s.d(t,{q:()=>r});var n,i=s(7095);function r(e,t=!0,s){const n=new a(e,t,s);return n.run(),n.tokens}!function(e){e[e.None=0]="None",e[e.Delimiter=1]="Delimiter",e[e.DoubleQuote=2]="DoubleQuote",e[e.SingleQuote=3]="SingleQuote",e[e.Whitespace=4]="Whitespace",e[e.Other=5]="Other"}(n||(n={}));class a{throwErrors;aliases;constructor(e,t,s){this.throwErrors=t,this.aliases=s,this._source=e,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new i.$g("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const e=this._offset,t=this._value;if(void 0!==this.aliases&&e!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const s=this.aliases.getRecursive(t);if(void 0!==s){const i=t.length;return this._offset=-1,this._index=e-1,this._aliasOffset=e,this._source=this._source.slice(0,e)+s+this._source.slice(e+i),this._prevChar="",this._prevCharType=n.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:e,value:t}),this._endQuote="",!0}_getCharType(e){return" ".includes(e)?n.Whitespace:";&|><".includes(e)?n.Delimiter:"'"===e?n.SingleQuote:'"'===e?n.DoubleQuote:n.Other}_endQuoteFromCharType(e){return e===n.DoubleQuote?'"':e===n.SingleQuote?"'":""}_next(){const e=++this._index,t=e<this._source.length?this._source[e]:" ";let s=this._getCharType(t);const i=this._endQuoteFromCharType(s);this._offset>=0?this._endQuote?t!==this._endQuote?this._value+=t:(this._endQuote="",s=n.Other):i?this._endQuote=i:s===n.Whitespace?this._addToken()&&(this._offset=-1):s!==this._prevCharType||s===n.Delimiter&&t!==this._prevChar?this._addToken()&&(this._offset=e,this._value=t):this._value+=t:s!==n.Whitespace&&(this._offset=e,this._endQuote=this._endQuoteFromCharType(s),this._value=""===this._endQuote?t:""),this._prevChar=t,this._prevCharType=s}_source;_tokens;_prevChar="";_prevCharType=n.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}}}]);